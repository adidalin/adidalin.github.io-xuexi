<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»¼åˆå­¦ä¹ ä¹å›­ (V34_Stable_Final)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        /* === æ­¤å¤„å®Œå…¨ä¿ç•™æ‚¨åŸæœ‰çš„æ‰€æœ‰ CSS æ ·å¼ï¼Œæœªåšä»»ä½•æ”¹åŠ¨ === */
        :root {
            --bg-color: #f0f2f5; --card-bg-color: #ffffff; --char-color: #2c3e50;
            --grid-color: #e0e0e0; --red-color: #d93025; --blue-color: #1a73e8;
            --yellow-color: #f9ab00; --gray-color: #5f6368; --green-color: #1e8e3e;
            --selection-bg-color: #e8f0fe; --selection-border-color: var(--blue-color);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-char: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --font-latin: Arial, sans-serif;
        }
        @media (min-width: 769px) { :root { --font-char: "KaiTi", "STKaiti", "æ¥·ä½“", "SimSun", "Songti SC", serif; } }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: var(--font-main); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; background-color: var(--bg-color); overflow: hidden; }
        .screen { position: absolute; width: 100%; max-width: 600px; display: flex; flex-direction: column; opacity: 0; visibility: hidden; pointer-events: none; z-index: -1; transition: opacity 0.2s; }
        .screen.active { opacity: 1; visibility: visible; pointer-events: auto; z-index: 100; }
        .card { background-color: var(--card-bg-color); padding: 20px 15px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); text-align: center; gap: 15px; }
        h1 { margin: 5px 0 15px 0; font-size: 1.5em; color: var(--char-color); }
        .btn { width: 100%; padding: 12px 0; font-size: 1em; font-weight: 600; color: white; border: none; border-radius: 8px; cursor: pointer; transition: opacity 0.2s; -webkit-tap-highlight-color: transparent; display: flex; align-items: center; justify-content: center; }
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        .btn-lg { font-size: 1.1em; padding: 14px 0; }
        .btn-primary { background-color: var(--blue-color); } 
        .btn-warning { background-color: var(--yellow-color); color: #fff; } 
        .btn-danger { background-color: var(--red-color); } 
        .btn-secondary { background-color: var(--gray-color); } 
        .btn-success { background-color: var(--green-color); }
        .btn-group { display: flex; gap: 15px; margin-top: 5px; width: 100%; }
        .btn-group .btn { margin: 0; flex: 1; }
        input, textarea, select { width: 100%; padding: 10px; font-size: 1em; border-radius: 6px; border: 1px solid #ccc; }
        details { border: 1px solid #eee; border-radius: 8px; margin-top: 10px; overflow: hidden; }
        summary { font-weight: bold; cursor: pointer; padding: 12px; list-style: none; background: #f8f9fa; }
        .details-content { padding: 15px; border-top: 1px solid #eee; }
        #bank-selection-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .bank-item { padding: 10px 5px; border: 1px solid #ddd; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; justify-content: center; height: 50px; }
        .bank-item.selected { background-color: var(--selection-bg-color); border-color: var(--selection-border-color); color: var(--blue-color); }
        #history-list { font-size: 0.9em; text-align: left; max-height: 150px; overflow-y: auto; }
        .history-item { padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
        .char-cell-container { position: relative; display: flex; justify-content: center; align-items: center; flex-shrink: 0; aspect-ratio: 1 / 1; border: 1px solid #eee; background: #fff; overflow: hidden; }
        .char-cell-grid { position: absolute; width: 100%; height: 100%; border: 2px solid var(--grid-color); }
        .char-cell-grid::before { content: ''; position: absolute; width: 1px; height: 100%; top: 0; left: 50%; background: var(--grid-color); transform: translateX(-50%); }
        .char-cell-grid::after { content: ''; position: absolute; height: 1px; width: 100%; top: 50%; left: 0; background: var(--grid-color); transform: translateY(-50%); }
        .char-cell-text { position: relative; font-family: var(--font-char); line-height: 1; z-index: 2; color: var(--char-color); font-weight: 500; }
        .char-item-latin { font-family: var(--font-latin); font-weight: bold; text-align: center; color: var(--char-color); line-height: 1.2; }
        .char-item-latin.is-pinyin { font-weight: normal; }
        #loading-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9em; display: none; z-index: 9999; }
        body.practice-mode { background-color: #fff; }
        @media (max-width: 768px) and (orientation: portrait) {
            body.practice-mode .screen.active { position: fixed; top: 50%; left: 50%; width: 100vh; height: 100vw; transform: translate(-50%, -50%) rotate(90deg); background: #fff; display: block; z-index: 200; padding: 0; margin: 0; box-shadow: none; border-radius: 0; }
        }
        .screen.practice-layout { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .practice-header { position: absolute; top: 0; left: 0; width: 100%; height: 40px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(255,255,255,0.95); z-index: 10; color: #666; border-bottom: 1px solid #f0f0f0; }
        .practice-footer { position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(255,255,255,0.95); z-index: 10; padding: 0 20px; border-top: 1px solid #f0f0f0; }
        .practice-body { position: absolute; top: 40px; bottom: 80px; left: 0; width: 100%; display: flex; justify-content: center; align-items: center; z-index: 1; overflow: hidden; }
        #char-display { display: flex; justify-content: center; align-items: center; gap: 4px; width: 100%; max-height: 100%; flex-wrap: nowrap; }
        @media (max-width: 768px) {
            .practice-body .char-cell-container { width: 19vh; height: 19vh; max-height: 55vw; max-width: 55vw; }
            .practice-body .char-cell-text { font-size: 15vh; }
            .practice-body .char-item-latin { font-size: 10vh; }
            .practice-footer .btn-group { gap: 20px; }
            .practice-footer .btn-lg { padding: 10px 0; font-size: 1.1em; }
        }
        @media (min-width: 769px) {
            .screen.practice-layout.active { max-width: 1000px; height: 80vh; background: #fff; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); left: 50%; top: 50%; transform: translate(-50%, -50%); position: fixed; }
            .practice-body .char-cell-container { width: 220px; height: 220px; }
            .practice-body .char-cell-text { font-size: 160px; }
            .practice-body .char-item-latin { font-size: 8rem; }
            .practice-header { font-size: 1.5em; height: 60px; }
            .practice-footer { height: 100px; }
            .practice-footer .btn-lg { font-size: 1.5em; padding: 20px 0; }
            .practice-body { top: 60px; bottom: 100px; }
        }
        body.practice-mode #result-screen.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        body.practice-mode #result-screen.active h1 { font-size: 8vh; margin: 0 0 20px 0; }
        body.practice-mode #result-screen.active p { font-size: 4vh; margin: 5px 0; }
    </style>
</head>
<body>
    <div id="loading-toast"></div>

    <!-- ä¸»é¡µ -->
    <div id="home-screen" class="screen card active">
        <h1>ç»¼åˆå­¦ä¹ ä¹å›­</h1>
        <div style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
            <button id="select-hanzi" class="btn btn-lg btn-primary">å­¦ä¹ æ±‰å­—</button>
            <button id="select-pinyin" class="btn btn-lg btn-success">å­¦ä¹ æ‹¼éŸ³</button>
            <button id="select-english" class="btn btn-lg btn-danger">å­¦ä¹ è‹±è¯­</button>
        </div>
        
        <details>
            <summary>æ•°æ®ç®¡ç†ä¸äº‘ç«¯åŒæ­¥</summary>
            <div class="details-content">
                <p style="font-size:0.85em; color:#666; margin-bottom:10px;">å¤§æ•°æ®å¼•æ“å·²å¯ç”¨ï¼Œæ”¯æŒè¶…å¤§è¯åº“ã€‚</p>
                <button id="force-fetch-btn" class="btn btn-warning" style="margin-bottom: 10px;">ğŸ”„ å¼ºåˆ¶é‡è½½äº‘ç«¯æ•°æ®(data.json)</button>
                <div class="btn-group">
                    <button id="export-data-btn" class="btn btn-secondary">å¤‡ä»½å¯¼å‡º</button>
                    <button id="import-data-btn" class="btn btn-secondary">æ¢å¤å¯¼å…¥</button>
                </div>
                <input type="file" id="import-file-input" style="display: none;" accept=".json">
            </div>
        </details>
    </div>

    <!-- å…¶ä½™ HTML ç»“æ„å®Œå…¨ä¿æŒä¸å˜... -->
    <div id="setup-screen" class="screen card">
        <h1 id="setup-title">è®¾ç½®</h1>
        <div id="bank-selection-list"></div>
        <div class="btn-group">
            <button id="start-btn" class="btn btn-primary btn-lg">å¼€å§‹</button>
            <button id="practice-wrong-btn" class="btn btn-warning btn-lg">é”™é¢˜</button>
        </div>
        <details>
            <summary>å†…å®¹ç®¡ç†</summary>
            <div class="details-content">
                <select id="bank-edit-select" style="margin-bottom:8px"></select>
                <input type="text" id="edit-bank-name" placeholder="è¯åº“åç§°" style="margin-bottom:8px">
                <textarea id="edit-bank-chars" rows="4" placeholder="å†…å®¹ï¼Œæ¯è¡Œä¸€ä¸ª"></textarea>
                <div class="btn-group">
                    <button id="save-bank-btn" class="btn btn-success">ä¿å­˜</button>
                    <button id="delete-bank-btn" class="btn btn-danger">åˆ é™¤</button>
                </div>
                <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px">
                    <textarea id="edit-wrong-chars" rows="2" placeholder="æ‰‹åŠ¨ç¼–è¾‘é”™é¢˜"></textarea>
                    <button id="save-wrong-chars-btn" class="btn btn-secondary" style="margin-top:8px">æ›´æ–°é”™é¢˜æœ¬</button>
                </div>
            </div>
        </details>
        <details>
            <summary>å†å²è®°å½•</summary>
            <div id="history-list" class="details-content"></div>
        </details>
        <button id="back-to-home-btn" class="btn btn-secondary" style="margin-top: 10px;">è¿”å›</button>
    </div>

    <div id="main-screen" class="screen practice-layout">
        <div class="practice-header">
            <span id="timer">00:00</span>
            <span>å‰©ä½™: <span id="remaining-count">0</span></span>
        </div>
        <div class="practice-body" id="practice-body-container"><div id="char-display"></div></div>
        <div class="practice-footer">
            <div class="btn-group">
                <button id="correct-btn" class="btn btn-success btn-lg">ğŸ˜Š è®¤è¯†</button>
                <button id="incorrect-btn" class="btn btn-danger btn-lg">ğŸ˜¥ ä¸è®¤è¯†</button>
            </div>
            <div style="margin-top: 5px;"><span id="exit-session-btn" style="color:#999; font-size:0.85em; text-decoration: underline; cursor: pointer;">ç»“æŸæœ¬æ¬¡ç»ƒä¹ </span></div>
        </div>
    </div>

    <div id="result-screen" class="screen practice-layout">
        <h1 id="result-title"></h1>
        <div style="margin: 10px 0; text-align: center;">
            <p>ç”¨æ—¶ï¼š<strong id="final-time"></strong></p>
            <p>é”™é¢˜ï¼š<strong id="incorrect-list" style="color: var(--red-color);"></strong></p>
        </div>
        <div style="width: 200px; margin-top: 20px;"><button id="home-btn" class="btn btn-secondary btn-lg">è¿”å›ä¸»é¡µ</button></div>
    </div>

    <script>
        /**
         * å­˜å‚¨é€»è¾‘å¢å¼ºæ–¹æ¡ˆï¼šåŒæ­¥å†…å­˜ + å¼‚æ­¥æ•°æ®åº“
         */
        const DB = {
            _data: {},
            _db: null,
            _dbName: 'LearningParkDB',
            _storeName: 'KVStore',

            // åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
            async init() {
                return new Promise((resolve) => {
                    // 1. å…ˆå°è¯•ä» localStorage æ¢å¤æœ€åŸºæœ¬çš„æ•°æ®ï¼Œç¡®ä¿é¡µé¢èƒ½ç¬é—´æ‰“å¼€
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        try { this._data[k] = JSON.parse(localStorage.getItem(k)); } catch(e) {}
                    }

                    // 2. å°è¯•è¿æ¥ IndexedDB
                    const request = indexedDB.open(this._dbName, 1);
                    request.onupgradeneeded = (e) => e.target.result.createObjectStore(this._storeName);
                    request.onsuccess = (e) => {
                        this._db = e.target.result;
                        // 3. ä»æ•°æ®åº“è¯»å–å¤§æ•°æ®è¦†ç›–å†…å­˜
                        const store = this._db.transaction([this._storeName], 'readonly').objectStore(this._storeName);
                        store.openCursor().onsuccess = (ev) => {
                            const cursor = ev.target.result;
                            if (cursor) {
                                this._data[cursor.key] = cursor.value;
                                cursor.continue();
                            } else {
                                resolve(); // è¯»å–å®Œæ¯•
                            }
                        };
                    };
                    request.onerror = () => { console.warn('DB fail, use LS'); resolve(); };
                });
            },

            get(k, d) { return this._data[k] !== undefined ? this._data[k] : d; },
            getS(s, k, d) { return this.get(`${s}_${k}`, d); },

            set(k, v) {
                this._data[k] = v; // ç«‹å³æ›´æ–°å†…å­˜ï¼Œç•Œé¢ä¸å¡é¡¿
                // åå°å¼‚æ­¥ä¿å­˜
                if (this._db) {
                    const tx = this._db.transaction([this._storeName], 'readwrite');
                    tx.objectStore(this._storeName).put(v, k);
                }
                // åŒæ—¶å¤‡ä»½å°æ•°æ®åˆ° localStorage (ç”¨äºåŒä¿é™©)
                try {
                    const str = JSON.stringify(v);
                    if (str.length < 100000) localStorage.setItem(k, str); 
                } catch(e) {}
            },
            setS(s, k, v) { this.set(`${s}_${k}`, v); },

            async clear() {
                this._data = {};
                localStorage.clear();
                if (this._db) {
                    const tx = this._db.transaction([this._storeName], 'readwrite');
                    tx.objectStore(this._storeName).clear();
                }
            }
        };

        const $ = (s) => document.querySelector(s);
        let state = { currentSubject: null, charsToPractice: [], currentChar: '', incorrectThisSession: [], seconds: 0, timerInterval: null };

        const UI = {
            getScreens: () => ({ home: $("#home-screen"), setup: $("#setup-screen"), main: $("#main-screen"), result: $("#result-screen") }),
            switchScreen(n) { 
                const screens = this.getScreens();
                Object.values(screens).forEach(s => s.classList.remove('active'));
                const target = screens[n];
                if(target) target.classList.add('active');
                document.body.classList.toggle('practice-mode', (n === 'main' || n === 'result'));
            },
            formatTime: (s) => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`,
            toast(msg) { const t = $("#loading-toast"); t.textContent = msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); },
            updateSetup() {
                const titles = { hanzi: 'æ±‰å­—', pinyin: 'æ‹¼éŸ³', english: 'è‹±è¯­' };
                $("#setup-title").textContent = titles[state.currentSubject] + "è®¾ç½®";
                const banks = DB.getS(state.currentSubject, 'wordBanks', {});
                const list = $("#bank-selection-list"); list.innerHTML = '';
                Object.keys(banks).forEach(name => {
                    const d = document.createElement('div'); d.className = 'bank-item'; d.textContent = name;
                    d.onclick = () => d.classList.toggle('selected'); d.dataset.name = name; list.appendChild(d);
                });
                const sel = $("#bank-edit-select"); sel.innerHTML = '<option value="">-- æ–°å»º/é€‰æ‹© --</option>';
                Object.keys(banks).forEach(n => sel.add(new Option(n, n)));
                UI.loadEditor('');
                const wrongs = DB.getS(state.currentSubject, 'wrongChars', []);
                $("#edit-wrong-chars").value = wrongs.join('\n');
                $("#practice-wrong-btn").textContent = `é”™é¢˜ (${wrongs.length})`;
                const h = DB.getS(state.currentSubject, 'practiceHistory', []);
                $("#history-list").innerHTML = h.length ? '' : 'æ— è®°å½•';
                h.slice(0, 5).forEach(i => $("#history-list").innerHTML += `<div class="history-item">${i.date} - ${i.wrong.length?'é”™'+i.wrong.length:'å…¨å¯¹'}</div>`);
            },
            loadEditor(n) {
                const banks = DB.getS(state.currentSubject, 'wordBanks', {});
                $("#edit-bank-name").value = n || '';
                $("#edit-bank-chars").value = (banks[n] || []).join('\n');
            },
            renderChar() {
                $("#remaining-count").textContent = state.charsToPractice.length;
                const box = $("#char-display"); box.innerHTML = '';
                if (state.currentSubject === 'hanzi') {
                    for (const char of state.currentChar) {
                        const cell = document.createElement('div'); cell.className = 'char-cell-container';
                        cell.innerHTML = `<div class="char-cell-grid"></div><div class="char-cell-text">${char}</div>`;
                        box.appendChild(cell);
                    }
                } else {
                    const item = document.createElement('div'); item.className = 'char-item-latin';
                    if(state.currentSubject === 'pinyin') item.classList.add('is-pinyin');
                    item.textContent = state.currentChar; box.appendChild(item);
                }
            }
        };

        function start(chars, src) {
            if (!chars || !chars.length) return alert('æ— å†…å®¹');
            state.charsToPractice = chars.sort(()=>Math.random()-0.5);
            state.incorrectThisSession = []; state.seconds = 0;
            UI.switchScreen('main');
            clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => { state.seconds++; $("#timer").textContent = UI.formatTime(state.seconds); }, 1000);
            next();
        }
        function next() {
            if (!state.charsToPractice.length) return end();
            state.currentChar = state.charsToPractice[0]; UI.renderChar();
        }
        function answer(ok) {
            if (ok) state.charsToPractice.shift();
            else {
                const w = state.currentChar;
                if (!state.incorrectThisSession.includes(w)) state.incorrectThisSession.push(w);
                const dbW = new Set(DB.getS(state.currentSubject, 'wrongChars', [])); dbW.add(w);
                DB.setS(state.currentSubject, 'wrongChars', [...dbW]);
                state.charsToPractice.push(state.charsToPractice.shift());
                state.charsToPractice.splice(Math.ceil(state.charsToPractice.length/2), 0, w);
            }
            next();
        }
        function end() {
            clearInterval(state.timerInterval);
            const h = DB.getS(state.currentSubject, 'practiceHistory', []);
            h.unshift({ date: new Date().toLocaleDateString(), time: UI.formatTime(state.seconds), wrong: [...state.incorrectThisSession] });
            DB.setS(state.currentSubject, 'practiceHistory', h.slice(0,20));
            $("#final-time").textContent = UI.formatTime(state.seconds);
            $("#incorrect-list").textContent = state.incorrectThisSession.join('ï¼Œ') || 'æ— ';
            $("#result-title").textContent = state.incorrectThisSession.length ? "åŠ æ²¹ï¼ğŸ‰" : "å…¨å¯¹ï¼ğŸ‰";
            UI.switchScreen('result');
            if (window.confetti) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        const bind = (id, fn) => { const el = $(id); if(el) el.onclick = fn; };
        
        window.onload = async () => {
            // 1. åˆå§‹åŒ–æ•°æ®åº“
            await DB.init();

            // 2. ç»‘å®šäº‹ä»¶ (åŸå°ä¸åŠ¨)
            bind('#select-hanzi', () => { state.currentSubject = 'hanzi'; UI.updateSetup(); UI.switchScreen('setup'); });
            bind('#select-pinyin', () => { state.currentSubject = 'pinyin'; UI.updateSetup(); UI.switchScreen('setup'); });
            bind('#select-english', () => { state.currentSubject = 'english'; UI.updateSetup(); UI.switchScreen('setup'); });
            bind('#back-to-home-btn', () => UI.switchScreen('home'));
            bind('#home-btn', () => UI.switchScreen('home'));
            bind('#exit-session-btn', end);
            bind('#correct-btn', () => answer(true));
            bind('#incorrect-btn', () => answer(false));
            bind('#start-btn', () => {
                const els = document.querySelectorAll('.bank-item.selected');
                if (!els.length) return alert('è¯·é€‰æ‹©è¯åº“');
                const banks = DB.getS(state.currentSubject, 'wordBanks', {});
                start(Array.from(els).flatMap(e => banks[e.dataset.name] || []), 'ç»ƒä¹ ');
            });
            bind('#practice-wrong-btn', () => {
                const w = DB.getS(state.currentSubject, 'wrongChars', []);
                w.length ? start(w, 'é”™é¢˜æœ¬') : alert('æ— é”™é¢˜');
            });
            $('#bank-edit-select').onchange = (e) => UI.loadEditor(e.target.value);
            bind('#save-bank-btn', () => {
                const n = $('#edit-bank-name').value.trim(), c = $('#edit-bank-chars').value.trim().split(/\n+/).filter(Boolean);
                if(n && c.length) { const b = DB.getS(state.currentSubject, 'wordBanks', {}); b[n] = c; DB.setS(state.currentSubject, 'wordBanks', b); UI.updateSetup(); alert('å·²ä¿å­˜'); }
            });
            bind('#delete-bank-btn', () => {
                const n = $('#edit-bank-name').value;
                if(n && confirm('åˆ é™¤?')) { const b = DB.getS(state.currentSubject, 'wordBanks', {}); delete b[n]; DB.setS(state.currentSubject, 'wordBanks', b); UI.updateSetup(); }
            });
            bind('#save-wrong-chars-btn', () => {
                const c = $('#edit-wrong-chars').value.trim().split(/\n+/).filter(Boolean);
                DB.setS(state.currentSubject, 'wrongChars', [...new Set(c)]); UI.updateSetup(); alert('å·²æ›´æ–°');
            });
            bind('#export-data-btn', () => {
                const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(DB._data)], {type:"application/json"})); a.download = `Backup_${new Date().getTime()}.json`; a.click();
            });
            bind('#import-data-btn', () => $('#import-file-input').click());
            $('#import-file-input').onchange = (e) => {
                const r = new FileReader();
                r.onload = async (ev) => { 
                    try {
                        const data = JSON.parse(ev.target.result);
                        await DB.clear();
                        Object.entries(data).forEach(([k,v]) => DB.set(k, v));
                        location.reload(); 
                    } catch(err) { alert('é”™è¯¯'); }
                };
                if(e.target.files[0]) r.readAsText(e.target.files[0]);
            };
            bind('#force-fetch-btn', () => { if(confirm('é‡è½½å°†è¦†ç›–åŒåè¯åº“ï¼Œç¡®å®šï¼Ÿ')) loadExternalData(true); });

            // 3. åˆå§‹æ£€æŸ¥
            if(!DB.getS('hanzi', 'wordBanks')) DB.setS('hanzi', 'wordBanks', {'å…¥é—¨':['å¤©','åœ°','äºº']});
            
            // 4. åŠ è½½å¤–éƒ¨æ•°æ®
            loadExternalData(false);

            // 5. æ˜¾ç¤ºä¸»é¡µ
            UI.switchScreen('home');
        };

        async function loadExternalData(force = false) {
            try {
                const res = await fetch('data.json?t=' + new Date().getTime());
                if (res.ok) {
                    const data = await res.json();
                    Object.entries(data).forEach(([k,v]) => {
                        const val = typeof v === 'string' ? JSON.parse(v) : v;
                        DB.set(k, val);
                    });
                    if(force) { UI.toast('åŒæ­¥æˆåŠŸ'); setTimeout(()=>location.reload(), 1000); }
                }
            } catch (e) {}
        }
    </script>
</body>
</html>
