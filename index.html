<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»¼åˆå­¦ä¹ ä¹å›­ (V12_Fixed)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5; --card-bg-color: #ffffff; --char-color: #2c3e50;
            --grid-color: #e0e0e0; --red-color: #d93025; --blue-color: #1a73e8;
            --yellow-color: #f9ab00; --gray-color: #5f6368; --green-color: #1e8e3e;
            --selection-bg-color: #e8f0fe; --selection-border-color: var(--blue-color);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-char: 'KaiTi', 'æ¥·ä½“', serif;
            --font-latin: Arial, sans-serif;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { 
            font-family: var(--font-main); 
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; margin: 0; padding: 10px;
            background-color: var(--bg-color); 
        }
        
        .screen { position: absolute; opacity: 1; visibility: visible; width: 100%; max-width: 600px; transition: opacity 0.2s; }
        .screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .card { 
            background-color: var(--card-bg-color); 
            padding: 20px 15px; 
            border-radius: 16px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); 
            width: 100%; 
            text-align: center; 
            display: flex; flex-direction: column; gap: 15px;
        }

        h1 { margin: 5px 0 15px 0; font-size: 1.5em; color: var(--char-color); }
        
        /* æŒ‰é’®æ ·å¼ï¼šå°å·§ç²¾è‡´ */
        .btn { 
            width: 100%; 
            padding: 10px 0; 
            font-size: 1em; 
            font-weight: 600; 
            color: white; border: none; border-radius: 8px; cursor: pointer; 
            transition: opacity 0.2s; 
            -webkit-tap-highlight-color: transparent;
        }
        .btn:active { opacity: 0.8; transform: scale(0.98); }
        .btn-lg { font-size: 1.05em; padding: 12px 0; }

        .btn-primary { background-color: var(--blue-color); } 
        .btn-warning { background-color: var(--yellow-color); color: #fff; } 
        .btn-danger { background-color: var(--red-color); } 
        .btn-secondary { background-color: var(--gray-color); } 
        .btn-success { background-color: var(--green-color); }
        
        .btn-group { display: flex; gap: 15px; margin-top: 10px; }
        .btn-group .btn { margin: 0; flex: 1; }

        input, textarea, select { width: 100%; padding: 10px; font-size: 1em; border-radius: 6px; border: 1px solid #ccc; }
        
        details { border: 1px solid #eee; border-radius: 8px; margin-top: 10px; overflow: hidden; }
        summary { font-weight: bold; cursor: pointer; padding: 12px; list-style: none; background: #f8f9fa; }
        summary::-webkit-details-marker { display: none; }
        .details-content { padding: 15px; border-top: 1px solid #eee; }
        
        /* --- æ ¸å¿ƒå±•ç¤ºåŒºåŸŸ --- */
        #char-display-container { 
            position: relative; 
            width: 100%; 
            margin: 20px 0 30px 0; 
            min-height: 160px;
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }

        #stats { 
            position: absolute; top: -35px; right: 0; 
            font-size: 0.85em; color: #999; 
        }

        #char-display { 
            display: flex; 
            flex-direction: row; 
            justify-content: center; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 4px; 
            width: 100%;
        }

        /* æ±‰å­—å®¹å™¨ï¼šå¤§å°ºå¯¸ */
        .char-cell-container { 
            position: relative; 
            display: flex; justify-content: center; align-items: center; 
            flex-shrink: 0;
            width: calc(25% - 4px); /* 4ä¸ªä¸€è¡Œ */
            aspect-ratio: 1 / 1; 
            max-width: 120px; 
        }

        .char-cell-grid { position: absolute; width: 100%; height: 100%; border: 2px solid var(--grid-color); }
        .char-cell-grid::before { content: ''; position: absolute; width: 1px; height: 100%; top: 0; left: 50%; background: var(--grid-color); transform: translateX(-50%); }
        .char-cell-grid::after { content: ''; position: absolute; height: 1px; width: 100%; top: 50%; left: 0; background: var(--grid-color); transform: translateY(-50%); }

        .char-cell-text { 
            position: relative; 
            font-family: var(--font-char); 
            line-height: 1;
            z-index: 2;
            color: var(--char-color);
            font-size: 19vw; /* æå¤§å­—ä½“ */
        }
        
        @media (min-width: 500px) {
            .char-cell-text { font-size: 90px; }
            .char-cell-container { height: 120px; } 
        }

        .char-item-latin { 
            font-family: var(--font-latin); 
            font-weight: bold; text-align: center; color: var(--char-color);
            font-size: clamp(3rem, 12vw, 5rem); 
            width: 100%;
        }
        .char-item-latin.is-pinyin { font-weight: normal; }

        /* åˆ—è¡¨ */
        #bank-selection-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .bank-item { padding: 10px 5px; border: 1px solid #ddd; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; justify-content: center; height: 50px; }
        .bank-item.selected { background-color: var(--selection-bg-color); border-color: var(--selection-border-color); color: var(--blue-color); }

        #history-list { font-size: 0.9em; text-align: left; max-height: 150px; overflow-y: auto; }
        .history-item { padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
        .wrong-chars { color: var(--red-color); }
    </style>
</head>
<body>
    <!-- ä¸»é¡µ -->
    <div id="home-screen" class="screen card">
        <h1>ç»¼åˆå­¦ä¹ ä¹å›­</h1>
        <div style="display: flex; flex-direction: column; gap: 10px; width: 100%;">
            <button id="select-hanzi" class="btn btn-lg btn-primary">å­¦ä¹ æ±‰å­—</button>
            <button id="select-pinyin" class="btn btn-lg btn-success">å­¦ä¹ æ‹¼éŸ³</button>
            <button id="select-english" class="btn btn-lg btn-danger">å­¦ä¹ è‹±è¯­</button>
        </div>
        
        <details>
            <summary>æ•°æ®å¤‡ä»½ä¸æ¢å¤</summary>
            <div class="details-content">
                <div class="btn-group">
                    <button id="export-data-btn" class="btn btn-secondary">å¯¼å‡ºæ•°æ®</button>
                    <button id="import-data-btn" class="btn btn-secondary">å¯¼å…¥æ•°æ®</button>
                </div>
                <input type="file" id="import-file-input" style="display: none;" accept=".json">
            </div>
        </details>
    </div>

    <!-- è®¾ç½®é¡µ -->
    <div id="setup-screen" class="screen card hidden">
        <h1 id="setup-title">è®¾ç½®</h1>
        <div id="bank-selection-list"></div>
        <div class="btn-group">
            <button id="start-btn" class="btn btn-primary btn-lg">å¼€å§‹</button>
            <button id="practice-wrong-btn" class="btn btn-warning btn-lg">é”™é¢˜</button>
        </div>
        
        <details>
            <summary>å†…å®¹ç®¡ç†</summary>
            <div class="details-content">
                <select id="bank-edit-select" style="margin-bottom:8px"></select>
                <input type="text" id="edit-bank-name" placeholder="è¯åº“åç§°" style="margin-bottom:8px">
                <textarea id="edit-bank-chars" rows="4" placeholder="å†…å®¹ï¼Œæ¯è¡Œä¸€ä¸ª"></textarea>
                <div class="btn-group">
                    <button id="save-bank-btn" class="btn btn-success">ä¿å­˜</button>
                    <button id="delete-bank-btn" class="btn btn-danger">åˆ é™¤</button>
                </div>
                <div style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px">
                    <textarea id="edit-wrong-chars" rows="2" placeholder="æ‰‹åŠ¨ç¼–è¾‘é”™é¢˜"></textarea>
                    <button id="save-wrong-chars-btn" class="btn btn-secondary" style="margin-top:8px">æ›´æ–°é”™é¢˜æœ¬</button>
                </div>
            </div>
        </details>
        
        <details>
            <summary>å†å²è®°å½•</summary>
            <div id="history-list" class="details-content"></div>
        </details>
        
        <button id="back-to-home-btn" class="btn btn-secondary" style="margin-top: 10px;">è¿”å›</button>
    </div>

    <!-- ç»ƒä¹ é¡µ -->
    <div id="main-screen" class="screen card hidden">
        <div id="char-display-container">
            <div id="stats"><span id="timer">00:00</span> | å‰©ä½™: <span id="remaining-count">0</span></div>
            <div id="char-display"></div>
        </div>
        
        <div class="btn-group">
            <button id="correct-btn" class="btn btn-success btn-lg">ğŸ˜Š è®¤è¯†</button>
            <button id="incorrect-btn" class="btn btn-danger btn-lg">ğŸ˜¥ ä¸è®¤è¯†</button>
        </div>
        <div style="margin-top: 15px;">
            <span id="exit-session-btn" style="color:#999; font-size:0.85em; text-decoration: underline; cursor: pointer;">ç»“æŸæœ¬æ¬¡ç»ƒä¹ </span>
        </div>
    </div>

    <!-- ç»“æœé¡µ -->
    <div id="result-screen" class="screen card hidden">
        <h1 id="result-title"></h1>
        <div style="margin: 10px 0;">
            <p>ç”¨æ—¶ï¼š<strong id="final-time"></strong></p>
            <p>é”™é¢˜ï¼š<strong id="incorrect-list" style="color: var(--red-color);"></strong></p>
        </div>
        <button id="home-btn" class="btn btn-secondary">è¿”å›ä¸»é¡µ</button>
    </div>

    <script>
        const $ = (s) => document.querySelector(s);
        let state = { currentSubject: null, charsToPractice: [], currentChar: '', incorrectThisSession: [], seconds: 0, timerInterval: null, currentSessionSource: '' };
        
        const DB = {
            get: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } },
            set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
            getS: (s, k, d) => DB.get(`${s}_${k}`, d),
            setS: (s, k, v) => DB.set(`${s}_${k}`, v)
        };

        const UI = {
            screens: { home: $("#home-screen"), setup: $("#setup-screen"), main: $("#main-screen"), result: $("#result-screen") },
            switchScreen(n) { Object.values(this.screens).forEach(s => s.classList.add('hidden')); this.screens[n].classList.remove('hidden'); },
            formatTime: (s) => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`,
            updateSetup() {
                const titles = { hanzi: 'æ±‰å­—', pinyin: 'æ‹¼éŸ³', english: 'è‹±è¯­' };
                $("#setup-title").textContent = titles[state.currentSubject] + "è®¾ç½®";
                const banks = DB.getS(state.currentSubject, 'wordBanks', {});
                const list = $("#bank-selection-list"); list.innerHTML = '';
                Object.keys(banks).forEach(name => {
                    const d = document.createElement('div'); d.className = 'bank-item'; d.textContent = name;
                    d.onclick = () => d.classList.toggle('selected'); d.dataset.name = name; list.appendChild(d);
                });
                const sel = $("#bank-edit-select"); sel.innerHTML = '<option value="">-- æ–°å»º/é€‰æ‹© --</option>';
                Object.keys(banks).forEach(n => sel.add(new Option(n, n)));
                UI.loadEditor('');
                const wrongs = DB.getS(state.currentSubject, 'wrongChars', []);
                $("#edit-wrong-chars").value = wrongs.join('\n');
                $("#practice-wrong-btn").textContent = `é”™é¢˜ (${wrongs.length})`;
                const h = DB.getS(state.currentSubject, 'practiceHistory', []);
                $("#history-list").innerHTML = h.length ? '' : 'æ— è®°å½•';
                h.slice(0, 5).forEach(i => $("#history-list").innerHTML += `<div class="history-item">${i.date} - ${i.wrong.length?'é”™'+i.wrong.length:'å…¨å¯¹'}</div>`);
            },
            loadEditor(n) {
                const banks = DB.getS(state.currentSubject, 'wordBanks', {});
                $("#edit-bank-name").value = n || '';
                $("#edit-bank-chars").value = (banks[n] || []).join('\n');
            },
            renderChar() {
                $("#remaining-count").textContent = state.charsToPractice.length;
                const box = $("#char-display"); box.innerHTML = '';
                
                // --- ä¿®å¤ç‚¹ï¼šæ¢å¤ä¸º for...of å¾ªç¯ ---
                if (state.currentSubject === 'hanzi') {
                    // ä½¿ç”¨ for...of æ¥å¤„ç†å­—ç¬¦ä¸²ï¼ˆå…¼å®¹å•ä¸ªå­—å’Œè¯è¯­ï¼‰
                    for (const char of state.currentChar) {
                        const cell = document.createElement('div'); 
                        cell.className = 'char-cell-container';
                        cell.innerHTML = `<div class="char-cell-grid"></div><div class="char-cell-text">${char}</div>`;
                        box.appendChild(cell);
                    }
                } else {
                    const item = document.createElement('div'); item.className = 'char-item-latin';
                    if(state.currentSubject === 'pinyin') item.classList.add('is-pinyin');
                    item.textContent = state.currentChar; box.appendChild(item);
                }
            }
        };

        function start(chars, src) {
            if (!chars || !chars.length) return alert('æ— å†…å®¹');
            state.charsToPractice = chars.sort(()=>Math.random()-0.5);
            state.incorrectThisSession = []; state.currentSessionSource = src; state.seconds = 0;
            UI.switchScreen('main');
            clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => { state.seconds++; $("#timer").textContent = UI.formatTime(state.seconds); }, 1000);
            next();
        }
        function next() {
            if (!state.charsToPractice.length) return end();
            state.currentChar = state.charsToPractice[0]; UI.renderChar();
        }
        function answer(ok) {
            if (ok) state.charsToPractice.shift();
            else {
                const w = state.currentChar;
                if (!state.incorrectThisSession.includes(w)) state.incorrectThisSession.push(w);
                const dbW = new Set(DB.getS(state.currentSubject, 'wrongChars', [])); dbW.add(w);
                DB.setS(state.currentSubject, 'wrongChars', [...dbW]);
                state.charsToPractice.push(state.charsToPractice.shift()); 
                state.charsToPractice.splice(Math.ceil(state.charsToPractice.length/2), 0, w);
            }
            next();
        }
        function end() {
            clearInterval(state.timerInterval);
            const h = DB.getS(state.currentSubject, 'practiceHistory', []);
            h.unshift({ date: new Date().toLocaleDateString(), time: UI.formatTime(state.seconds), wrong: [...state.incorrectThisSession] });
            DB.setS(state.currentSubject, 'practiceHistory', h.slice(0,20));
            $("#final-time").textContent = UI.formatTime(state.seconds);
            $("#incorrect-list").textContent = state.incorrectThisSession.join('ï¼Œ') || 'æ— ';
            $("#result-title").textContent = state.incorrectThisSession.length ? "åŠ æ²¹ï¼" : "å…¨å¯¹ï¼ğŸ‰";
            if (!state.incorrectThisSession.length) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            UI.switchScreen('result');
        }

        const bind = (id, fn) => $(id).onclick = fn;
        bind('#select-hanzi', () => { state.currentSubject = 'hanzi'; UI.updateSetup(); UI.switchScreen('setup'); });
        bind('#select-pinyin', () => { state.currentSubject = 'pinyin'; UI.updateSetup(); UI.switchScreen('setup'); });
        bind('#select-english', () => { state.currentSubject = 'english'; UI.updateSetup(); UI.switchScreen('setup'); });
        bind('#back-to-home-btn', () => UI.switchScreen('home'));
        bind('#home-btn', () => UI.switchScreen('home'));
        bind('#exit-session-btn', end);
        bind('#correct-btn', () => answer(true));
        bind('#incorrect-btn', () => answer(false));
        bind('#start-btn', () => {
            const els = document.querySelectorAll('.bank-item.selected');
            if (!els.length) return alert('è¯·é€‰æ‹©è¯åº“');
            const banks = DB.getS(state.currentSubject, 'wordBanks', {});
            start(Array.from(els).flatMap(e => banks[e.dataset.name] || []), 'ç»ƒä¹ ');
        });
        bind('#practice-wrong-btn', () => {
            const w = DB.getS(state.currentSubject, 'wrongChars', []);
            w.length ? start(w, 'é”™é¢˜æœ¬') : alert('æ— é”™é¢˜');
        });
        $('#bank-edit-select').onchange = (e) => UI.loadEditor(e.target.value);
        bind('#save-bank-btn', () => {
            const n = $('#edit-bank-name').value.trim(), c = $('#edit-bank-chars').value.trim().split(/\n+/).filter(Boolean);
            if(n && c.length) { const b = DB.getS(state.currentSubject, 'wordBanks', {}); b[n] = c; DB.setS(state.currentSubject, 'wordBanks', b); UI.updateSetup(); alert('å·²ä¿å­˜'); }
        });
        bind('#delete-bank-btn', () => {
            const n = $('#edit-bank-name').value;
            if(n && confirm('åˆ é™¤?')) { const b = DB.getS(state.currentSubject, 'wordBanks', {}); delete b[n]; DB.setS(state.currentSubject, 'wordBanks', b); UI.updateSetup(); }
        });
        bind('#save-wrong-chars-btn', () => {
            const c = $('#edit-wrong-chars').value.trim().split(/\n+/).filter(Boolean);
            DB.setS(state.currentSubject, 'wrongChars', [...new Set(c)]); UI.updateSetup(); alert('å·²æ›´æ–°');
        });
        bind('#export-data-btn', () => {
            const d = {}; for(let i=0; i<localStorage.length; i++) d[localStorage.key(i)] = localStorage.getItem(localStorage.key(i));
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(d)], {type:"application/json"})); a.download = `Backup.json`; a.click();
        });
        bind('#import-data-btn', () => $('#import-file-input').click());
        $('#import-file-input').onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => { if(confirm('è¦†ç›–?')) { localStorage.clear(); Object.entries(JSON.parse(ev.target.result)).forEach(([k,v])=>localStorage.setItem(k,v)); location.reload(); } };
            if(e.target.files[0]) r.readAsText(e.target.files[0]);
        };
        window.onload = () => {
            if(!localStorage.getItem('hanzi_wordBanks')) DB.setS('hanzi', 'wordBanks', {'å…¥é—¨':['å¤©','åœ°','äºº']});
            if(!localStorage.getItem('pinyin_wordBanks')) DB.setS('pinyin', 'wordBanks', {'å•éŸµæ¯':['a','o','e']});
            if(!localStorage.getItem('english_wordBanks')) DB.setS('english', 'wordBanks', {'Test':['Cat','Dog']});
            UI.switchScreen('home');
        };
    </script>
</body>
</html>